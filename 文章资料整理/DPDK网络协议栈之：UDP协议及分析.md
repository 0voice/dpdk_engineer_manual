# DPDK网络协议栈之：UDP协议及分析 

## **1.UDP协议** 

UDP是User Datagram Protocol的简称， 中文名是用户数据报协议，是OSI（Open System Interconnection，开放式系统互联） 参考模型中一种无连接的传输层协议，提供面向事务的简单不可靠信息传送服务，IETF RFC 768是UDP的正式规范。UDP在IP报文的协议号是17。    

UDP协议的全称是用户数据报协议，在网络中它与TCP协议一样用于处理数据包，是一种无连接的协议。在OSI模型中，在第四层——传输层，处于IP协议的上一层。UDP有不提供数据包分组、组装和不能对数据包进行排序的缺点，也就是说，当报文发送之后，是无法得知其是否安全完整到达的。UDP用来支持那些需要在计算机之间传输数据的网络应用。包括网络视频会议系统在内的众多的客户/服务器模式的网络应用都需要使用UDP协议。UDP协议从问世至今已经被使用了很多年，虽然其最初的光彩已经被一些类似协议所掩盖，但是即使是在今天UDP仍然不失为一项非常实用和可行的网络传输层协议。 

与所熟知的TCP（传输控制协议）协议一样，UDP协议直接位于IP（网际协议）协议的顶层。根据OSI（开放系统互连）参考模型，UDP和TCP都属于传输层协议。UDP协议的主要作用是将网络数据流量压缩成数据包的形式。一个典型的数据包就是一个二进制数据的传输单位。每一个数据包的前8个字节用来包含报头信息，剩余字节则用来包含具体的传输数据。 

##  **2.UDP协议的主要特点** 

（1） UDP是无连接的，即发送数据之前不需要建立连接。 

（2） UDP 使用尽最大努力交付，即不保证可靠交付，同时也不使用拥塞控制。 

（3） UDP 是面向报文的。UDP 没有拥塞控制，很适合多媒体通信的要求。  

（4） UDP 支持一对一、一对多、多对一和多对多的交互通信。 

（5） UDP 的首部开销小，只有 8 个字节。 



## **3.UDP协议的使用** 

在选择使用协议的时候，选择UDP必须要谨慎。在网络质量令人十分不满意的环境下，UDP协议数据包丢失会比较严重。但是由于UDP的特性：它不属于连接型协议，因而具有资源消耗小，处理速度快的优点，所以通常音频、视频和普通数据在传送时使用UDP较多，因为它们即使偶尔丢失一两个数据包，也不会对接收结果产生太大影响。比如我们聊天用的ICQ和QQ就是使用的UDP协议。 



## **4.UDP协议的报头** 

###  **4.1面向报文的 UDP**

发送方 UDP 对应用程序交下来的报文，在添加首部后就向下交付 IP 层。UDP 对应用层交下来的报文，既不合并，也不拆分，而是保留这些报文的边界。 应用层交给 UDP 多长的报文，UDP 就照样发送，即一次发送一个报文。 接收方 UDP 对 IP 层交上来的 UDP 用户数据报，在去除首部后就原封不动地交付上层的应用进程，一次交付一个完整的报文。 应用程序必须选择合适大小的报文。



### **4.2UDP报文的组成**

UDP报头由4个域组成，其中每个域各占用2个字节，具体如下：UDP源端口号、目标端口号、数据报长度、校验值

![img](https://pic1.zhimg.com/80/v2-d4386171e2f1f5ee7f77a401b22c61c8_720w.jpeg)

编辑切换为居中

添加图片注释，不超过 140 字（可选）

UDP协议使用端口号为不同的应用保留其各自的数据传输通道。UDP和TCP协议正是采用这一机制实现对同一时刻内多项应用同时发送和接收数据的支持。数据发送一方（可以是客户端或服务器端）将UDP数据包通过源端口发送出去，而数据接收一方则通过目标端口接收数据。有的网络应用只能使用预先为其预留或注册的静态端口；而另外一些网络应用则可以使用未被注册的动态端口。因为UDP报头使用两个字节存放端口号，所以端口号的有效范围是从0到65535。一般来说，大于49151的端口号都代表动态端口。 

数据报的长度是指包括报头和数据部分在内的总字节数。因为报头的长度是固定的，所以该域主要被用来计算可变长度的数据部分（又称为数据负载）。数据报的最大长度根据操作环境的不同而各异。从理论上说，包含报头在内的数据报的最大长度为65535字节。不过，一些实际应用往往会限制数据报的大小，有时会降低到8192字节。 UDP协议使用报头中的校验值来保证数据的安全。校验值首先在数据发送方通过特殊的算法计算得出，在传递到接收方之后，还需要再重新计算。如果某个数据报在传输过程中被第三方篡改或者由于线路噪音等原因受到损坏，发送和接收方的校验计算值将不会相符，由此UDP协议可以检测是否出错。这与TCP协议是不同的，后者要求必须具有校验值。 

许多链路层协议都提供错误检查，包括流行的以太网协议，也许你想知道为什么UDP也要提供检查和校验。其原因是链路层以下的协议在源端和终端之间的某些通道可能不提供错误检测。虽然UDP提供有错误检测，但检测到错误时，UDP不做错误校正，只是简单地把损坏的消息段扔掉，或者给应用程序提供警告信息。 

UDP Helper是实现对指定UDP端口广播报文的中继转发，即将指定UDP端口的广播报文转换为单播报文发送给指定的服务器，起到中继的作用. 

### **4.3UDP 的首部格式** 

![img](https://picx.zhimg.com/80/v2-59dfbe58cfe109538ab0ec250930c5b5_720w.jpeg)



编辑切换为居中

添加图片注释，不超过 140 字（可选）

 用户数据报 UDP 有两个字段：数据字段和首部字段。首部字段有 8 个字节，由 4 个字段组成，每个字段都是两个字节。

![img](https://pica.zhimg.com/80/v2-f858246be36fda479cecda20b09bb5b5_720w.jpeg)



编辑切换为居中

添加图片注释，不超过 140 字（可选）

五、UDP报文段的校验 

UDP首部校验和的计算IP/ICMP/IGMP/TCP/UDP等协议的校验和算法都是相同的，算法如下： 

在发送数据时，为了计算IP数据包的校验和。应该按如下步骤： 

（1）把IP数据包的校验和字段置为0；  

（2）把首部看成以16位为单位的数字组成，依次进行二进制反码求和；    

（3）把得到的结果存入校验和字段中。  



在接收数据时，计算数据包的校验和相对简单，按如下步骤：    

（1）把首部看成以16位为单位的数字组成，依次进行二进制反码求和，包括校验和字段；  

（2）检查计算出的校验和的结果是否等于零（反码应为16个1）；

（3）如果等于零，说明被整除，校验是和正确。否则，校验和就是错误的，协议栈要抛弃这个数据包。  

 

所谓的二进制反码求和，即为先进行二进制求和，然后对和取反。   计算对IP首部检验和的算法如下：    

（1）把IP数据包的校验和字段置为0；  

（2）把首部看成以16位为单位的数字组成，依次进行二进制求和（注意：求和时应将最高位的进位保存，所以加法应采用32位加法）；    

（3）将上述加法过程中产生的进位（最高位的进位）加到低16位（采用32位加法时，即为将高16位与低16位相加，之后还要把该次加法最高位产生的进位加到低16位）    

（4）将上述的和取反，即得到校验和。





原文链接：https://blog.csdn.net/times_poem/article/details/51383463

原文作者：Times_poem

